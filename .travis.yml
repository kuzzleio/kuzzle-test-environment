services:
  - docker

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test

before_install: sudo ./scripts/pre-install.sh

script: sudo ./scripts/install.sh && sudo ./scripts/run.sh

after_success: sudo ./scripts/success.sh
after_failure: sudo ./scripts/errored.sh

after_script: "echo ENDED"

os: linux
sudo: required

env:
  global:
    - NODE_VERSION: 6.9.5
    - GLOBAL_PM2_VERSION: 2.0.19
    - GCC_VERSION: 4.9
    - ES_VERSION: 5
    - REDIS_VERSION: 3
  matrix:
    # RC9.6 entreprise version (round-robin)
    - KUZZLE_REPO: kuzzleio/kuzzle
      KUZZLE_VERSION: 1.0.0-RC9.6
      KUZZLE_PLUGINS: kuzzleio/kuzzle-plugin-auth-passport-local@3.0.4:kuzzleio/kuzzle-plugin-logger@2.0.7:kuzzleio/kuzzle-plugin-cluster@1.x
      PROXY_REPO: kuzzleio/kuzzle-load-balancer
      PROXY_VERSION: 1.x
      LB_PROXY_VERSION: kuzzleio/kuzzle-proxy@1.0.0-RC9
      "proxy_backend__mode": round-robin
      "kuzzle_plugins__kuzzle-plugin-cluster__privileged": true
      "kuzzle_services__internalBroker__socket": false
      "kuzzle_services__internalBroker__host": 0.0.0.0
      "kuzzle_services__internalBroker__port": 7911
    # RC9.6 entreprise version (failover)
    - KUZZLE_REPO: kuzzleio/kuzzle
      KUZZLE_VERSION: 1.0.0-RC9.6
      KUZZLE_PLUGINS: kuzzleio/kuzzle-plugin-auth-passport-local@3.0.4:kuzzleio/kuzzle-plugin-logger@2.0.7:kuzzleio/kuzzle-plugin-cluster@1.x
      PROXY_REPO: kuzzleio/kuzzle-load-balancer
      PROXY_VERSION: 1.x
      LB_PROXY_VERSION: kuzzleio/kuzzle-proxy@1.0.0-RC9
      "proxy_backend__mode": failover
      "kuzzle_plugins__kuzzle-plugin-cluster__privileged": true
      "kuzzle_services__internalBroker__socket": false
      "kuzzle_services__internalBroker__host": 0.0.0.0
      "kuzzle_services__internalBroker__port": 7911
